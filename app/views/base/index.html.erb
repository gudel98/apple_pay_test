<div class="container py-1 jumbotron" style="background-color: white">
  <span style="margin-right: 40%">
    <%= image_tag 'ecomcharge.png', size: '130x100' %>
    <%= image_tag 'apple_pay.png', size: '200x100' %>
  </span>
  <span style="font-size: 2rem; font-weight: 700">ApplePay Test</span>
</div>
<section class="content text-center">
  <div class="container" style="padding: inherit">
    <div class="messages" style="display: none"></div>
    <div class="row">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="authorization">
              <h4>Authorization</h4>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-dark" onclick="openWidget('authorization')">Authorize</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="capture">
              <h4>Partial shipment</h4>
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="authorization uid" id="parent_uid">
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-secondary" onclick="sendChildTxn('capture')">Capture</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="void">
              <h4>Void</h4>
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="authorization uid" id="parent_uid">
                <div id="amount" style="display: none"></div>
              </div>
              <button type="button" class="btn btn-secondary" onclick="sendChildTxn('void')">Void</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-sm-4">
        <div class="card" style="height: 100%">
          <div class="card-body">
            <form id="payment">
              <h4>One-time</h4>
              <div id="apple-pay-button">
                <!-- <div id="apple-pay" onclick="runApplePay()" class="apple-pay-button-with-text apple-pay-button-white-with-text">
                  <span class="text">Buy with</span>
                  <span class="logo"></span>
                </div> -->
              </div>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-dark" onclick="openWidget('payment')">Pay</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="refund">
              <h4>Refund</h4>
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="payment uid" id="parent_uid">
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-secondary" onclick="sendChildTxn('refund')">Refund</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="recurring">
              <h4>Recurring payment</h4>
              <input type="text" class="form-control" placeholder="credit card token" id="token">
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-dark" onclick="sendRecurring()">Pay</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="close_day">
              <h4>Settlement</h4>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="gateway id" id="gateway_id">
              </div>
              <button type="button" class="btn btn-outline-dark" onclick="sendCloseDay()">Close day</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script type="text/javascript" src="https://js-staging.begateway.com/widget/be_gateway.js"></script>
<script type="text/javascript" src="https://js-staging.begateway.com/widget/apple_pay.js"></script>
<script>
  window.onload = () => {
    const params = { checkout_url: 'https://checkout-staging.begateway.com', checkout: { apple_pay_container_id: 'apple-pay-button' } };
    const { checkout_url, checkout: { apple_pay_container_id } } = params;
    this.pay = new ApplePay({
      apple_pay_container_id,
      checkout_url,
      token: '',
      public_key: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0++mGSWP00f7L0mwaXkwVFqdwUmJlGodVALZv7k1UO35ERPxIg+iGqhPNYoAKn9OgP1dlbqJbGAUkdnLhlnt6lbAIn35zs8q3mwJfuwn9c+3FhNQa4UAIGQYOP1dPjXqxyJ1ZPU0G99QHZGHi0t+PZfbXWz7HOtFv+MHz9u2bv9zn6MNq1rTUJ5Xv1xtqjRFzFYp7ySIRsBuTGSxbqYWUiA10qKz8ySEuGfo80vmv81af+udLBI/cgoaYdaLvX+VkPOart8se+tVclQCJHQLwNtL+99mO+hzdpKFGBu9nBVkH+g76YfWGG7H3laW+c0w1zY3npiUwXrzYbYqikztLwIDAQAB'
    }).pay;
  }

  this.openWidget = function(txn_type) {
    $.ajax({
      url: "/" + txn_type,
      type: "post",
      data: {
        amount: $("#" + txn_type + " #amount")[0].value,
        currency: $("#" + txn_type + " #currency")[0].value,
        txn_type: txn_type
      },
      datatype: 'script',
      beforeSend: function(data) {
        showMessage('warning', 'Sending request...')
      }
    })
  };

  let timerId;

  showMessage = function(alert, message) {
    clearTimeout(timerId);
    if ($('.messages').is(':visible')) { $('.messages').slideUp('fast') };
    var messages = $('.messages')
    var successHtml = '<div class="alert alert-' + alert + '" role="alert">' + message + '</div>';
    $(messages).html(successHtml);
    $('.messages').slideDown('fast');
    timerId = setTimeout(function(){ $('.messages').slideUp('fast'); }, 10000);
  }

  this.sendChildTxn = function(txn_type) {
    $.ajax({
      url: "/" + txn_type,
      type: "post",
      data: {
        amount: $("#" + txn_type + " #amount")[0].value,
        parent_uid: $("#" + txn_type + " #parent_uid")[0].value
      },
      datatype: 'script',
      beforeSend: function(data) {
        showMessage('warning', 'Sending request...')
      },
      success: function(data) {
        if (data.status == 200) {
          showMessage('success', data.message);
        } else {
          showMessage('danger', data.message);
        }
      }
    })
  };

  this.sendRecurring = function() {
    $.ajax({
      url: "/recurring",
      type: "post",
      data: {
        amount: $("#recurring #amount")[0].value,
        currency: $("#recurring #currency")[0].value,
        token: $("#recurring #token")[0].value
      },
      datatype: 'script',
      beforeSend: function(data) {
        showMessage('warning', 'Sending request...');
        $(window).scrollTop(0);
      },
      success: function(data) {
        if (data.status == 200) {
          showMessage('success', data.message);
        } else {
          showMessage('danger', data.message);
        }
      }
    })
  };

  this.sendCloseDay = function() {
    $.ajax({
      url: "/close_day",
      type: "post",
      data: {
        gateway_id: $("#close_day #gateway_id")[0].value,
        currency: $("#close_day #currency")[0].value
      },
      datatype: 'script',
      beforeSend: function(data) {
        showMessage('warning', 'Sending request...')
        $(window).scrollTop(0);
      },
      success: function(data) {
        if (data.status == 200) {
          showMessage('success', data.message);
        } else {
          showMessage('danger', data.message);
        }
      }
    })
  };
</script>
