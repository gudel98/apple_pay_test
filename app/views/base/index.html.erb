<div class="container py-1 jumbotron" style="background-color: white">
  <span style="margin-right: 40%">
    <%= image_tag 'ecomcharge.png', size: '130x100' %>
    <%= image_tag 'apple_pay.png', size: '200x100' %>
  </span>
  <span style="font-size: 2rem; font-weight: 700">ApplePay Test</span>
</div>
<section class="content text-center">
  <div class="container" style="padding: inherit">
    <div class="messages" style="display: none"></div>
    <div class="row">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="authorization">
              <h4>Authorization</h4>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-dark" onclick="openWidget('authorization')">Authorize</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="capture">
              <h4>Partial shipment</h4>
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="authorization uid" id="parent_uid">
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-secondary" onclick="sendChildTxn('capture')">Capture</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="void">
              <h4>Void</h4>
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="authorization uid" id="parent_uid">
                <div id="amount" style="display: none"></div>
              </div>
              <button type="button" class="btn btn-secondary" onclick="sendChildTxn('void')">Void</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-sm-4">
        <div class="card" style="height: 100%">
          <div class="card-body">
            <form id="payment">
              <h4>One-time</h4>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-dark" onclick="openWidget('payment')">Pay</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="refund">
              <h4>Refund</h4>
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="payment uid" id="parent_uid">
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-secondary" onclick="sendChildTxn('refund')">Refund</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="recurring">
              <h4>Recurring payment</h4>
              <input type="text" class="form-control" placeholder="credit card token" id="token">
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="amount(0.00)" id="amount">
              </div>
              <button type="button" class="btn btn-dark" onclick="sendRecurring()">Pay</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <form id="close_day">
              <h4>Settlement</h4>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle"
                          type="button" data-toggle="dropdown" id="currency" value="BYN">BYN</button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item">BYN</a>
                    <a class="dropdown-item">USD</a>
                    <a class="dropdown-item">EUR</a>
                  </div>
                </div>
                <input type="text" class="form-control" placeholder="gateway id" id="gateway_id">
              </div>
              <button type="button" class="btn btn-outline-dark" onclick="sendCloseDay()">Close day</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script type="text/javascript" src="https://js-staging.begateway.com/widget/be_gateway.js"></script>
<script>
  this.openWidget = function(txn_type) {
    var formObject = {};
    var currency = $("#" + txn_type + " #currency")[0].value;
    var amount = parseInt( $("#" + txn_type + " #amount")[0].value ) * 100;
    var params = {
      checkout_url: "https://checkout-staging.begateway.com",
      widget: "https://js-staging.begateway.com/widget/widget.html",
      style: {
        header: {
          backgroundColor: '#fff',
          border: 'none'
        },
        headerPrice: {
          color: '#fff'
        },
        footer: {
          backgroundColor: '#fff',
          border: 'none'
        },
        cardButton: {
          backgroundColor: '#26d893',
          border: 'none'
        },
        methodButton: {
          backgroundColor: '#26d893',
          border: 'none'
        },
        paymentResultButton: {
          backgroundColor: '#26d893',
          border: 'none'
        }
      },
      checkout: {
        iframe: true,
        test: true,
        transaction_type: txn_type,
        // Demo shop authorization token:
        attempts: 1,
        public_key: "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtE3/Z3W3dQ8e5WbQrV/74THSOgX0EFHUrAikS0TUqfrxk5caEW8peb9AXXKtAjM7Hl28couSr39YfxfaKPuCcwtML9Q+z7pQBLVzLFHiGRytBStlNkOVY3pPiM9cfkqGX/oSCuaS3c+xY8LNZeYCDoQcQzQW95sqAdqzzp18Mo3Lpv2IpLYVC+64O9tIXoCz7LVAKpm7R4pCFb5Pc8BestDGUnH1MS9MsrmvtEu5EXSDLe0biY146sWoOKtuMduqdDZOU4E/k51ZVto8Lt7/2DV7NbmdHoMvb2ws5aMaVUT3An4xFzJe97ATPp9M8DMFYojgfPSTBtlsC5KswsRCHQIDAQAB",
        order: {
          amount: amount,
          currency: currency,
          description: "ApplePay test order",
          additional_data: {
            customer: {
              id: "b17727a9-0632-4454-b639-b941826be36f"
            }
          }
        },
        payment_method: {
          // types: ["visa", "halva", "erip", "much_better", "qiwi", "bank_pay"],
          bank_pay: { channel: "Hexopay" },
          cash_to_code: { channel: "Hexopay" },
          much_better: { channel: "1|Hexopay" },
          pay_r_transfer: { channel: "ONLINE" },
          qiwi: { channel: "qw|Hexopay" },
          safety_pay: { channel: "ONLINE" },
          skrill: { account: "admin+buyer@ecomcharge.com" }
        },
        settings: {
          language: "ru",
          return_url: "",
          notification_url: "",
          require: []
        }
      },
      closeWidget: function(status) {
        console.log('close widget callback with status:', status)
      }
    };
    // var form = document.getElementById('paymentForm');
    // var data = new FormData(form);

    // $.map($('form').serializeArray(), function (v, i) {
    //   formObject[v['name']] = v['value']
    // })

    // params.checkout.public_key = formObject.public_key;
    // params.checkout.order.amount = formObject.amount;
    // params.checkout.order.currency = formObject.currency;
    // params.checkout.settings.language = formObject.language;
    // params.checkout.settings.notification_url = formObject.notification_url;
    // params.checkout.settings.return_url = formObject.return_url;

    new BeGateway(params).createWidget();
  };

  let timerId;

  showMessage = function(alert, message) {
    clearTimeout(timerId);
    if ($('.messages').is(':visible')) { $('.messages').slideUp('fast') };
    var messages = $('.messages')
    var successHtml = '<div class="alert alert-' + alert + '" role="alert">' + message + '</div>';
    $(messages).html(successHtml);
    $('.messages').slideDown('fast');
    timerId = setTimeout(function(){ $('.messages').slideUp('fast'); }, 10000);
  }

  this.sendChildTxn = function(txn_type) {
    $.ajax({
      url: "/" + txn_type,
      type: "post",
      data: {
        amount: $("#" + txn_type + " #amount")[0].value,
        parent_uid: $("#" + txn_type + " #parent_uid")[0].value
      },
      datatype: 'script',
      beforeSend: function(data) {
        showMessage('warning', 'Sending request...')
      },
      success: function(data) {
        if (data.status == 200) {
          showMessage('success', data.message);
        } else {
          showMessage('danger', data.message);
        }
      }
    })
  };

  this.sendRecurring = function() {
    $.ajax({
      url: "/recurring",
      type: "post",
      data: {
        amount: $("#recurring #amount")[0].value,
        currency: $("#recurring #currency")[0].value,
        token: $("#recurring #token")[0].value
      },
      datatype: 'script',
      beforeSend: function(data) {
        showMessage('warning', 'Sending request...');
        $(window).scrollTop(0);
      },
      success: function(data) {
        if (data.status == 200) {
          showMessage('success', data.message);
        } else {
          showMessage('danger', data.message);
        }
      }
    })
  };

  this.sendCloseDay = function() {
    $.ajax({
      url: "/close_day",
      type: "post",
      data: {
        gateway_id: $("#close_day #gateway_id")[0].value,
        currency: $("#close_day #currency")[0].value
      },
      datatype: 'script',
      beforeSend: function(data) {
        showMessage('warning', 'Sending request...')
        $(window).scrollTop(0);
      },
      success: function(data) {
        if (data.status == 200) {
          showMessage('success', data.message);
        } else {
          showMessage('danger', data.message);
        }
      }
    })
  };
</script>
